<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>TarsDB - Dashboard Builder</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f0f0f; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; padding-bottom: 15px; margin-bottom: 20px; }
        h1 { background: linear-gradient(90deg, #00d4ff, #ae00ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; font-size: 1.8rem; }
        .badge { background: #222; padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; color: #888; border: 1px solid #333; }

        /* Upload Zone */
        .upload-area { background: #181818; border: 2px dashed #333; border-radius: 10px; padding: 20px; text-align: center; transition: all 0.3s; cursor: pointer; margin-bottom: 20px; }
        .upload-area:hover { border-color: #00d4ff; background: #1f1f1f; }
        .btn-select { background: #2563eb; color: white; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; display: inline-block; margin-top: 10px; }
        input[type="file"] { display: none; }

        /* Control Bar & Dropdowns */
        .controls { display: grid; grid-template-columns: 1fr 1fr auto; gap: 20px; background: #181818; padding: 15px; border-radius: 10px; border: 1px solid #333; margin-bottom: 20px; align-items: end; }
        
        .input-group label { display: block; color: #888; font-size: 0.8rem; margin-bottom: 5px; }
        select { width: 100%; background: #222; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 5px; font-size: 1rem; outline: none; }
        select:focus { border-color: #00d4ff; }

        .metrics { text-align: right; min-width: 150px; }
        .metric-val { font-size: 1.5rem; font-weight: bold; color: #fff; }
        .metric-lbl { font-size: 0.7rem; color: #666; text-transform: uppercase; }

        /* Charts Grid */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: #181818; padding: 15px; border-radius: 12px; border: 1px solid #333; height: 400px; position: relative; }
        
        #loading { display: none; color: #00d4ff; margin-top: 10px; font-weight: bold; }
        #fileInfo { font-size: 0.9rem; color: #00c853; margin-top: 10px; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>ðŸš€ TarsDB v2.1</h1>
                <div style="font-size: 0.9rem; color: #666;">Self-Service Dashboard Builder</div>
            </div>
            <div class="badge">Rust Core + SheetJS</div>
        </header>

        <div class="upload-area" id="dropZone">
            <div style="font-size: 1.1rem; color: #ccc;">Excel (.xlsx) veya CSV dosyanÄ±zÄ± buraya sÃ¼rÃ¼kleyin</div>
            <label for="fileInput" class="btn-select">Dosya SeÃ§</label>
            <input type="file" id="fileInput" accept=".csv, .xlsx, .xls">
            <div id="loading">âš¡ Motor Veriyi Ä°ÅŸliyor...</div>
            <div id="fileInfo"></div>
        </div>

        <div class="controls">
            <div class="input-group">
                <label>SOL GRAFÄ°K (Analiz Boyutu 1)</label>
                <select id="sel1" disabled><option>Dosya YÃ¼kleyin...</option></select>
            </div>
            <div class="input-group">
                <label>SAÄž GRAFÄ°K (Analiz Boyutu 2)</label>
                <select id="sel2" disabled><option>Dosya YÃ¼kleyin...</option></select>
            </div>
            <div class="metrics">
                <div class="metric-val" id="totalRows">0</div>
                <div class="metric-lbl">Filtreli SatÄ±r</div>
            </div>
        </div>

        <div class="grid">
            <div class="card"><canvas id="chart1"></canvas></div>
            <div class="card"><canvas id="chart2"></canvas></div>
        </div>
        
        <p style="text-align: center; color: #444; margin-top: 15px; font-size: 0.8rem;">
            Grafiklere tÄ±klayarak filtreleyin (Green/Gray Logic). MenÃ¼lerden kolon deÄŸiÅŸtirerek yeni analiz yapÄ±n.
        </p>
    </div>

    <script type="module">
        import init, { TarsEngine } from './pkg/tars_db.js';

        let db = null;
        let chart1, chart2;
        let activeCol1 = null, activeCol2 = null;
        
        // Qlik Renkleri
        const C_GREEN = '#00c853'; 
        const C_BLUE  = '#00d4ff'; 
        const C_GRAY  = '#333333';

        async function run() {
            await init();
            db = new TarsEngine();
            initCharts();

            // Event Listeners
            document.getElementById('fileInput').addEventListener('change', handleFile, false);
            
            // Dropdown DeÄŸiÅŸimleri
            document.getElementById('sel1').addEventListener('change', (e) => {
                activeCol1 = e.target.value;
                updateDashboard();
            });
            document.getElementById('sel2').addEventListener('change', (e) => {
                activeCol2 = e.target.value;
                updateDashboard();
            });
        }

        function handleFile(evt) {
            const file = evt.target.files[0];
            if (!file) return;

            document.getElementById('loading').style.display = 'block';
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = e.target.result;
                
                // Excel -> CSV Ã‡evrimi
                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    const wb = XLSX.read(data, {type: 'binary'});
                    const csv = XLSX.utils.sheet_to_csv(wb.Sheets[wb.SheetNames[0]]);
                    loadToEngine(csv, file.name);
                } else {
                    loadToEngine(data, file.name);
                }
            };

            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) reader.readAsBinaryString(file);
            else reader.readAsText(file);
        }

        function loadToEngine(csvData, fileName) {
            // 1. Rust Motoruna GÃ¶nder
            const msg = db.load_csv_data(csvData);
            
            // 2. UI GÃ¼ncelle
            document.getElementById('loading').style.display = 'none';
            const infoDiv = document.getElementById('fileInfo');
            infoDiv.style.display = 'block';
            infoDiv.innerText = `âœ… ${fileName} | ${msg}`;

            // 3. KolonlarÄ± Dropdown'a Doldur
            const cols = db.get_column_names().split(',').filter(c => c.trim() !== "");
            populateSelect('sel1', cols);
            populateSelect('sel2', cols);

            // 4. VarsayÄ±lan SeÃ§im (Ä°lk 2 kolon)
            if (cols.length >= 2) {
                document.getElementById('sel1').value = cols[0];
                document.getElementById('sel2').value = cols[1];
                activeCol1 = cols[0];
                activeCol2 = cols[1];
                updateDashboard();
            }
        }

        function populateSelect(id, options) {
            const sel = document.getElementById(id);
            sel.innerHTML = "";
            sel.disabled = false;
            options.forEach(opt => {
                const el = document.createElement("option");
                el.textContent = opt;
                el.value = opt;
                sel.appendChild(el);
            });
        }

        function initCharts() {
            const opt = (getCol) => ({
                responsive: true, maintainAspectRatio: false,
                onClick: (e, el) => handleClick(getCol(), el),
                plugins: { legend: { display: false }, title: { display: true, color: '#fff', font: {size:16} } },
                scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: '#333' } } }
            });

            chart1 = new Chart(document.getElementById('chart1'), {
                type: 'bar', data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
                options: opt(() => activeCol1)
            });

            chart2 = new Chart(document.getElementById('chart2'), {
                type: 'bar', data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
                options: opt(() => activeCol2)
            });
        }

        function handleClick(field, elements) {
            if (elements.length === 0) return;
            const idx = elements[0].index;
            
            // Hangi grafik tÄ±klandÄ±ysa onun label'Ä±nÄ± al
            const chart = field === activeCol1 ? chart1 : chart2;
            const value = chart.data.labels[idx];
            
            db.toggle_selection(field, value);
            updateDashboard();
        }

        function updateDashboard() {
            if (!activeCol1 || !activeCol2) return;

            const render = (chart, col) => {
                // Kolon BaÅŸlÄ±ÄŸÄ±nÄ± GrafiÄŸe Yaz
                chart.options.plugins.title.text = col;

                // Veriyi Rust'tan Ã‡ek
                const labels = db.get_top_values(col).split(',').filter(s => s);
                const data = [];
                const colors = [];

                labels.forEach(val => {
                    const state = db.get_state(col, val);
                    if (state === 0) {
                        // Gri (Excluded)
                        data.push(db.query_global_count(col, val));
                        colors.push(C_GRAY);
                    } else {
                        // YeÅŸil veya Mavi
                        data.push(db.query_count(col, val));
                        colors.push(state === 2 ? C_GREEN : C_BLUE);
                    }
                });

                chart.data.labels = labels;
                chart.data.datasets[0].data = data;
                chart.data.datasets[0].backgroundColor = colors;
                chart.update();
            };

            render(chart1, activeCol1);
            render(chart2, activeCol2);

            document.getElementById('totalRows').innerText = db.get_total_filtered().toLocaleString();
        }

        run();
    </script>
</body>
</html>